syntax = "proto3";

option java_multiple_files = true;
option java_package = "com.sonarsource.a3s.analyzer.grpc";
option java_outer_classname = "LanguageAnalyzerProto";

package analyzer;

// Language Analyzer Service
service LanguageAnalyzerService {
  // Analyze a file
  rpc Analyze(AnalyzeRequest) returns (AnalyzeResponse);
}

// Request to analyze a file
message AnalyzeRequest {
  string analysis_id = 1; // A unique UUID identifier for each analysis
  map<string, string> context_ids = 2; // Map of context ID by kind
  repeated SourceFile source_files = 3; // List of source files to analyze
  repeated ActiveRule active_rules = 4; // List of active rules
}

// Represents a source file to be analyzed.
//
// relative_path: the relative path of the file
// content: the content of the file
// file_scope: the scope of the file (MAIN or TEST). This is optional.
//             When provided, it takes precedence over any scope deduced from the context.
//             When not provided, the scope should be deduced from the context if available.
//             When neither is provided, the analyzer should perform best effort to determine the scope.
message SourceFile {
  string relative_path = 1;
  string content = 2;
  optional FileScope file_scope = 3;
}

// Enum for file scope
enum FileScope {
  MAIN = 0;
  TEST = 1;
}

// Response containing analysis results
message AnalyzeResponse {
  repeated Issue issues = 1;
  repeated AnalysisProblem analysis_problems = 2;
}

// Represents a problem encountered during analysis
message AnalysisProblem {
  AnalysisProblemType type = 1;    // Type of the problem
  string message = 2;              // Description of the problem
  string file_path = 3;            // Optional path to the file where the problem occurred
}

// Enum for analysis problem types
enum AnalysisProblemType {
  ANALYSIS_PROBLEM_TYPE_UNDEFINED = 0;
  ANALYSIS_PROBLEM_TYPE_PARSING = 1;
}

// Represents an active rule with configuration
message ActiveRule {
  RuleKey rule_key = 1;            // Structured rule key
  repeated RuleParam params = 2;   // Optional configuration parameters
}

// Represents a rule parameter
message RuleParam {
  string key = 1;
  string value = 2;
}

// Represents a rule key with repository and rule identifier
message RuleKey {
  string repo = 1;  // Repository (e.g., "java", "javascript", "typescript")
  string rule = 2;  // Rule identifier (e.g., "S1172", "S100")
}

// Represents a code issue found during analysis
message Issue {
  reserved 1;                      // Previously: id (string) - now generated by proxy service
  string file_path = 2;            // Path to the file containing the issue
  string message = 3;              // Descriptive message
  RuleKey rule = 4;                // Structured rule key
  TextRange text_range = 5;        // Location in the file
  repeated Flow flows = 6;         // Optional data/control flow paths
}

// Represents a text range in a file
message TextRange {
  int32 start_line = 1;            // 1-indexed
  int32 start_line_offset = 2;     // 0-indexed character offset
  int32 end_line = 3;              // 1-indexed
  int32 end_line_offset = 4;       // 0-indexed character offset
}

// Flow type enumeration
enum FlowType {
  FLOW_TYPE_UNDEFINED = 0;
  FLOW_TYPE_DATA = 1;
  FLOW_TYPE_EXECUTION = 2;
}

// Represents a flow (sequence of locations)
message Flow {
  FlowType type = 1;
  string description = 2;
  repeated FlowLocation locations = 3;
}

// Represents a location in a flow
message FlowLocation {
  TextRange text_range = 1;
  string message = 2;              // Description of the step
  string file = 3;                 // File path where this location exists
}
