name: Label ESLint Plugin PRs

on:
  pull_request:
    types: ["opened", "synchronize", "edited"]
    paths:
      - 'packages/jsts/src/rules/**'

jobs:
  add_eslint_plugin_label:
    name: Add eslint-plugin label to Jira
    runs-on: github-ubuntu-latest-s
    permissions:
      id-token: write
      pull-requests: read
    # Only run for internal PRs (not forks) and not from bots
    if: |
        github.event.pull_request.head.repo.full_name == github.repository
        && github.event.sender.type != 'Bot'
    steps:
      - name: Extract Jira key from PR title
        id: extract-jira-key
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          # Extract Jira key (e.g., JS-1234) from the beginning of the title
          JIRA_KEY=$(echo "$PR_TITLE" | grep -oE '^[A-Z]+-[0-9]+' || echo "")
          if [ -z "$JIRA_KEY" ]; then
            echo "No Jira key found in PR title: $PR_TITLE"
            echo "has_jira_key=false" >> $GITHUB_OUTPUT
          else
            echo "Found Jira key: $JIRA_KEY"
            echo "jira_key=$JIRA_KEY" >> $GITHUB_OUTPUT
            echo "has_jira_key=true" >> $GITHUB_OUTPUT
          fi

      - id: secrets
        if: steps.extract-jira-key.outputs.has_jira_key == 'true'
        uses: SonarSource/vault-action-wrapper@v3
        with:
          secrets: |
            development/kv/data/jira user | JIRA_USER;
            development/kv/data/jira token | JIRA_TOKEN;

      - name: Add eslint-plugin label
        if: steps.extract-jira-key.outputs.has_jira_key == 'true'
        env:
          VAULT_OUTPUT: ${{ steps.secrets.outputs.vault }}
          JIRA_KEY: ${{ steps.extract-jira-key.outputs.jira_key }}
        run: |
          JIRA_USER=$(echo "$VAULT_OUTPUT" | jq -r '.JIRA_USER')
          JIRA_TOKEN=$(echo "$VAULT_OUTPUT" | jq -r '.JIRA_TOKEN')
          # Use Jira REST API to add label
          curl -s -X PUT \
            -H "Content-Type: application/json" \
            -u "$JIRA_USER:$JIRA_TOKEN" \
            -d '{"update": {"labels": [{"add": "eslint-plugin"}]}}' \
            "https://sonarsource.atlassian.net/rest/api/3/issue/$JIRA_KEY"
          echo "Added 'eslint-plugin' label to $JIRA_KEY"
