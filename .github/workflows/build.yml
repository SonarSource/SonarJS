name: Build
on:
  push:
    branches:
      - master
      - branch-*
      - dogfood-*
  pull_request:
  merge_group:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # Nightly for analyze and iris tasks

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  setup:
    runs-on: github-ubuntu-latest-s
    name: Setup - Prepare Node.js versions and test hashes
    permissions: &read_permissions
      id-token: write
      contents: read
    outputs:
      node-matrix: ${{ steps.generate-matrix.outputs.matrix }}
      js-files-hash: ${{ steps.compute-js-hash.outputs.hash }}
      maven-hash: ${{ steps.compute-maven-hash.outputs.hash }}
      npm-hash: ${{ steps.compute-npm-hash.outputs.hash }}
    steps:
      - &checkout
        name: Checkout source code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Generate Node.js version matrix from package.json
        id: generate-matrix
        run: |
          # Extract node version range from package.json and parse versions with jq
          MATRIX=$(jq -c '{
            "node-version": (
              .engines.node
              | split(" || ")
              | map(gsub("^[~^>=<]+"; ""))
            )
          }' package.json)

          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "Generated Node.js version matrix from package.json: $MATRIX"
      - name: Compute JS files hash for test caching
        id: compute-js-hash
        run: |
          HASH=$(find packages patches sonar-plugin/javascript-checks/src/main/resources/org/sonar/l10n/javascript/rules tools typings .nycrc package.json server.mjs -type f 2>/dev/null | sort | xargs sha256sum | sha256sum | cut -d' ' -f1)
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "Computed JS files hash: $HASH"
      - name: Compute Maven hash for cache key
        id: compute-maven-hash
        run: |
          HASH=$(find . -name 'pom.xml' -type f | sort | xargs sha256sum | sha256sum | cut -d' ' -f1)
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "Computed Maven hash: $HASH"
      - name: Compute NPM hash for cache key
        id: compute-npm-hash
        run: |
          HASH=$(sha256sum package-lock.json patches/* 2>/dev/null | sha256sum | cut -d' ' -f1)
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "Computed NPM hash: $HASH"

  config_maven:
    runs-on: github-ubuntu-latest-s
    name: Configure Maven
    needs: setup
    permissions: *read_permissions
    steps:
      - *checkout
      - &mise_java_maven
        name: Setup Java and Maven
        uses: jdx/mise-action@v3.4.0
        with:
          version: 2025.11.2
          mise_toml: |
            [tools]
            java = "17.0"
            maven = "3.9"
      - name: Configure Maven
        id: config-maven
        uses: SonarSource/ci-github-actions/config-maven@master
        with:
          artifactory-reader-role: private-reader

  populate_maven_cache:
    runs-on: github-ubuntu-latest-m
    name: Populate Maven cache for Linux
    needs: [setup, config_maven]
    permissions: *read_permissions
    steps: &populate_maven_cache_steps
      - name: Check Maven cache
        id: cache
        uses: SonarSource/ci-github-actions/cache@v1
        with:
          path: ~/.m2/repository
          key: maven-${{ runner.os }}-${{ needs.setup.outputs.maven-hash }}
          lookup-only: true
      - name: Checkout source code
        if: steps.cache.outputs.cache-hit != 'true'
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - if: steps.cache.outputs.cache-hit != 'true'
        name: Setup Java and Maven
        uses: jdx/mise-action@v3.4.0
        with:
          version: 2025.11.2
          mise_toml: |
            [tools]
            java = "17.0"
            maven = "3.9"
      - if: steps.cache.outputs.cache-hit != 'true'
        name: Configure Maven
        uses: SonarSource/ci-github-actions/config-maven@master
        with:
          artifactory-reader-role: private-reader
      - if: steps.cache.outputs.cache-hit != 'true'
        name: Populate Maven dependencies
        run: |
          # Download all external dependencies (excludes reactor/internal modules)
          mvn dependency:go-offline -B

  populate_npm_cache:
    runs-on: github-ubuntu-latest-s
    name: Populate NPM cache for Linux
    needs: setup
    permissions: *read_permissions
    steps: &populate_npm_cache_steps
      - name: Cache NPM dependencies
        id: cache
        uses: SonarSource/ci-github-actions/cache@v1
        with:
          path: node_modules
          key: npm-${{ runner.os }}-${{ needs.setup.outputs.npm-hash }}
          lookup-only: true
      - name: Checkout source code
        if: steps.cache.outputs.cache-hit != 'true'
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - if: steps.cache.outputs.cache-hit != 'true'
        name: Setup Node
        uses: jdx/mise-action@v3.4.0
        with:
          version: 2025.11.2
          mise_toml: |
            [tools]
            node = "24.11.0"
      - if: steps.cache.outputs.cache-hit != 'true'
        id: secrets
        name: Access vault secrets
        uses: SonarSource/vault-action-wrapper@v3
        with:
          secrets: |
            development/artifactory/token/${{ github.repository_owner }}-${{ github.event.repository.name }}-private-reader access_token | ARTIFACTORY_ACCESS_TOKEN;
      - if: steps.cache.outputs.cache-hit != 'true'
        name: Configure npm registry
        run: |
          npm config set //repox.jfrog.io/artifactory/api/npm/:_authToken=${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
          npm config set registry https://repox.jfrog.io/artifactory/api/npm/npm/
      - if: steps.cache.outputs.cache-hit != 'true'
        name: Install NPM dependencies
        run: npm ci

  build:
    runs-on: github-ubuntu-latest-m
    name: Build SonarJS on Linux
    needs: [setup, populate_maven_cache, populate_npm_cache]
    permissions: *read_permissions
    steps:
      - *checkout
      - &mise
        uses: jdx/mise-action@v3.4.0
        with:
          version: 2025.11.2
          mise_toml: |
            [tools]
            java = "17.0"
            maven = "3.9"
            node = "24.11.0"
      - &npm_cache
        name: Cache NPM dependencies
        uses: SonarSource/ci-github-actions/cache@v1
        with:
          path: node_modules
          key: npm-${{ runner.os }}-${{ needs.setup.outputs.npm-hash }}
      - &maven_cache
        name: Cache Maven repository
        uses: SonarSource/ci-github-actions/cache@v1
        with:
          path: ~/.m2/repository
          key: maven-${{ runner.os }}-${{ needs.setup.outputs.maven-hash }}
      - uses: SonarSource/ci-github-actions/build-maven@master
        with:
          deploy: true
          deploy-pull-request: true
          artifactory-reader-role: private-reader
          artifactory-deployer-role: qa-deployer
          sonar-platform: none
          maven-args: '-DskipTests -T1C'
      - &config_maven
        name: Configure Maven
        id: config-maven
        uses: SonarSource/ci-github-actions/config-maven@master
        with:
          artifactory-reader-role: private-reader
      - &upload_maven_targets
        name: Upload Maven target artifacts
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: maven-targets-${{ runner.os }}-${{ github.sha }}
          path: |
            **/target/
            !**/target/site/
          retention-days: 1

  plugin_qa_fast_without_node_alpine:
    runs-on: github-ubuntu-latest-m
    name: Fast QA without Node on Alpine SQ:LATEST_RELEASE
    needs: [setup, build]
    permissions: *read_permissions
    container:
      image: alpine:latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Setup Java and Maven
        uses: jdx/mise-action@v3.4.0
        with:
          version: 2025.11.2
          mise_toml: |
            [tools]
            java = "17.0"
            maven = "3.9"
      - *maven_cache
      - *config_maven
      - id: secrets
        uses: SonarSource/vault-action-wrapper@v3
        with:
          secrets: |
            development/github/token/licenses-ro token | licenses_token;
      - name: Disable existing node
        shell: bash
        run: |
          node --version
          NODE_PATH=$(which node)
          sudo mv "$NODE_PATH" "${NODE_PATH}.disabled"
          
          # Verify node is no longer accessible
          if which node 2>/dev/null; then
            echo "ERROR: node is still accessible!"
            exit 1
          else
            echo "SUCCESS: node is no longer accessible"
          fi
