# SonarJS Build Process Documentation

This document provides a comprehensive breakdown of what happens when you run `mvn clean install` on the SonarJS project.

## Table of Contents

- [Project Structure](#project-structure)
- [Module Build Order](#module-build-order)
- [Build Phases Overview](#build-phases-overview)
- [Phase-by-Phase Breakdown](#phase-by-phase-breakdown)
  - [CLEAN Phase](#clean-phase)
  - [INITIALIZE Phase](#initialize-phase)
  - [GENERATE-SOURCES Phase](#generate-sources-phase)
  - [GENERATE-RESOURCES Phase](#generate-resources-phase)
  - [PROCESS-RESOURCES Phase](#process-resources-phase)
  - [COMPILE Phase](#compile-phase)
  - [TEST Phase](#test-phase)
  - [PACKAGE Phase](#package-phase)
  - [VERIFY Phase](#verify-phase)
  - [INSTALL Phase](#install-phase)
- [NPM Scripts Reference](#npm-scripts-reference)
- [RSPEC Metadata Dependency Chain](#rspec-metadata-dependency-chain)
- [Git Tracking Status](#git-tracking-status)
- [Build Profiles](#build-profiles)
- [Key Maven Plugins](#key-maven-plugins)
- [Known Issues and Notes](#known-issues-and-notes)

---

## Project Structure

```
SonarJS/
├── pom.xml                          # Root POM (aggregator)
├── package.json                     # NPM workspace root
├── packages/                        # TypeScript/JavaScript source
│   └── jsts/src/rules/              # ESLint rule implementations
├── resources/                       # Generated resources (gitignored)
│   └── rule-data/                   # RSPEC downloaded data
├── tools/                           # Build scripts
├── sonar-plugin/                    # Maven modules
│   ├── pom.xml                      # Aggregator POM
│   ├── api/                         # API module (jar)
│   ├── bridge/                      # Node.js bridge module (jar)
│   ├── css/                         # CSS analyzer module (jar)
│   ├── javascript-checks/           # Rule definitions module (jar)
│   ├── sonar-javascript-plugin/     # Main plugin (sonar-plugin)
│   ├── standalone/                  # Standalone analyzer (jar)
│   └── coverage-report/             # Coverage aggregation (profile only)
└── its/                             # Integration tests
    ├── plugin/                      # Plugin integration tests
    │   ├── tests/
    │   ├── fast-tests/
    │   └── sonarlint-tests/
    └── ruling/                      # Ruling tests
```

---

## Module Build Order

Modules are built in the order declared in `sonar-plugin/pom.xml`:

```
1. api
2. bridge
3. css
4. javascript-checks
5. sonar-javascript-plugin
6. standalone
```

> **Note**: This order has implications for the RSPEC metadata dependency chain. See [Known Issues](#known-issues-and-notes).

---

## Build Phases Overview

Maven executes phases in order. For `mvn clean install`, the relevant phases are:

```
clean → initialize → generate-sources → generate-resources → process-resources
      → compile → process-test-resources → test-compile → test
      → package → verify → install
```

---

## Phase-by-Phase Breakdown

### CLEAN Phase

Removes build artifacts and generated files.

| Module                      | Execution ID                     | Command/Plugin                                  | Description                         |
| --------------------------- | -------------------------------- | ----------------------------------------------- | ----------------------------------- |
| **root**                    | `flatten.clean`                  | flatten-maven-plugin                            | Cleans flattened POM files          |
| **bridge**                  | `Clean the npm dependencies`     | `rm -rf lib bin`                                | Removes compiled JS bridge          |
| **bridge**                  | `Clean the resources`            | `rm -f src/main/resources/node-info.properties` | Removes generated properties        |
| **bridge**                  | `Clean autogenerated modules`    | `git clean -xdf packages/jsts/src/rules/`       | Removes `generated-meta.ts` files   |
| **javascript-checks**       | `Clean the Rule Data`            | `rm -rf resources/rule-data`                    | Removes downloaded RSPEC data       |
| **javascript-checks**       | `Clean the Generated Classes`    | `git clean -xdf`                                | Removes generated Java classes      |
| **sonar-javascript-plugin** | `Clean the resources`            | `rm -f src/main/resources/node-info.properties` | Removes generated properties        |
| **coverage-report**         | `Clean the Java Coverage folder` | `rm -rf coverage/java`                          | Only with `coverage-report` profile |

### INITIALIZE Phase

Early initialization before main build phases.

| Module                      | Execution ID                      | Command/Plugin                                                             | Description                                                            |
| --------------------------- | --------------------------------- | -------------------------------------------------------------------------- | ---------------------------------------------------------------------- |
| **sonar-javascript-plugin** | `Validate quickfix configuration` | `npm run validate-quickfix`                                                | Validates RSPEC quickfix declarations match rule implementations       |
| **sonar-javascript-plugin** | `Generate Node.js properties`     | `node tools/sync-nodejs-versions.mjs sonar-plugin/sonar-javascript-plugin` | Generates `node-info.properties` for Maven property extraction         |
| **sonar-javascript-plugin** | (read-project-properties)         | properties-maven-plugin                                                    | Reads `node-info.properties` into `${node.min.version}` Maven property |

#### Why `validate-quickfix` runs here

The `validate-quickfix` script (`tools/validate-quickfix.ts`) ensures consistency between:

- RSPEC metadata (`quickfix: 'covered'`)
- ESLint rule meta (`fixable` or `hasSuggestions`)
- Rule metadata (`quickFixMessage` export)

This catches configuration errors early before the full build.

#### Why `node-info.properties` is generated twice

The same script runs in both **sonar-javascript-plugin** (initialize) and **bridge** (generate-resources):

| Module                      | Phase              | Purpose                                                      |
| --------------------------- | ------------------ | ------------------------------------------------------------ |
| **sonar-javascript-plugin** | initialize         | Maven property `${node.min.version}` for JAR manifest        |
| **bridge**                  | generate-resources | Runtime classpath resource for `NodeDeprecationWarning.java` |

The sonar-javascript-plugin generation must happen in `initialize` because the Maven property is needed before bridge is built. Even though sonar-javascript-plugin depends on bridge, Maven properties must be resolved early.

### GENERATE-SOURCES Phase

Generates Java source code.

| Module     | Execution ID                     | Plugin                | Description                                                                                |
| ---------- | -------------------------------- | --------------------- | ------------------------------------------------------------------------------------------ |
| **bridge** | `Generate Protobuf Java Sources` | protobuf-maven-plugin | Compiles `packages/jsts/src/parsers/*.proto` → Java classes in `target/generated-sources/` |

The protobuf plugin uses the OS-specific protoc compiler, detected via `os-maven-plugin`.

### GENERATE-RESOURCES Phase

Generates resources and builds the TypeScript bridge.

#### bridge module

| Execution ID                  | Command                                                   | Description                                  |
| ----------------------------- | --------------------------------------------------------- | -------------------------------------------- |
| `Build the bridge`            | `npm run bridge:build:fast`                               | Main TypeScript build (see breakdown below)  |
| `Bundle the bridge`           | `npm run bridge:bundle`                                   | esbuild bundling for production              |
| `Pack the bridge`             | `npm pack`                                                | Creates `sonarjs-1.0.0.tgz` npm package      |
| `Generate Node.js properties` | `node tools/sync-nodejs-versions.mjs sonar-plugin/bridge` | Generates `node-info.properties` for runtime |

**`npm run bridge:build:fast` breakdown:**

```
bridge:build:fast
├── npm run _:bridge:clear           # rimraf lib/*
├── npm run generate-meta            # tsx tools/generate-meta.ts
│   └── Reads sonar-plugin/javascript-checks/src/main/resources/
│   │         org/sonar/l10n/javascript/rules/javascript/*.json
│   └── Generates packages/jsts/src/rules/*/generated-meta.ts
└── npm run bridge:compile           # tsgo (TypeScript compilation)
    └── npm run _:bridge:copy-protofiles
```

#### javascript-checks module

| Execution ID                                | Command/Plugin                       | Description                                                                                                                                       |
| ------------------------------------------- | ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------- |
| `Generate Javascript/Typescript rules data` | rspec-maven-plugin                   | Downloads JS/TS RSPEC → `resources/rule-data/javascript/`                                                                                         |
| `Generate CSS rules data`                   | rspec-maven-plugin                   | Downloads CSS RSPEC → `resources/rule-data/css/`                                                                                                  |
| `Deploy the rule data`                      | `npm run deploy-rule-data`           | Copies RSPEC to `sonar-plugin/javascript-checks/src/main/resources/org/sonar/l10n/javascript/rules/javascript/`, creates `Sonar_way_profile.json` |
| `Generate the Java Check classes`           | `npm run generate-java-rule-classes` | Generates Java rule checker classes from templates                                                                                                |
| `Update README with rule counts`            | `npm run count-rules`                | Updates rule count documentation                                                                                                                  |

### PROCESS-RESOURCES Phase

Processes and copies resources.

| Module                      | Execution ID                     | Plugin                  | Description                                                    |
| --------------------------- | -------------------------------- | ----------------------- | -------------------------------------------------------------- |
| **root**                    | `flatten`                        | flatten-maven-plugin    | Resolves `${revision}` property in POMs                        |
| **bridge**                  | `Copy the bridge to the package` | maven-resources-plugin  | Copies `sonarjs-1.0.0.tgz` → `target/classes/`                 |
| **sonar-javascript-plugin** | `unpack-node-runtimes`           | maven-dependency-plugin | Unpacks Node.js runtimes for 6 platforms → `target/downloads/` |

The Node.js runtimes are downloaded from `org.sonarsource.nodejs:nodejs-runtime` artifact and include:

- `win-x64/node.exe.xz`
- `linux-x64/bin/node.xz`
- `linux-x64-musl/bin/node.xz` (Alpine)
- `linux-arm64/bin/node.xz`
- `darwin-x64/bin/node.xz`
- `darwin-arm64/bin/node.xz`

### COMPILE Phase

Compiles Java source code.

| Module                      | Description                                |
| --------------------------- | ------------------------------------------ |
| **api**                     | API interfaces and base classes            |
| **bridge**                  | Bridge code + generated protobuf classes   |
| **css**                     | CSS analyzer implementation                |
| **javascript-checks**       | Rule definitions + generated check classes |
| **sonar-javascript-plugin** | Main plugin class and integration          |
| **standalone**              | Standalone analyzer library                |

All modules compile with Java 17 (`maven.compiler.release=17`).

### TEST Phase

Runs unit tests with maven-surefire-plugin (version 3.1.2).

| Configuration   | Value                                      |
| --------------- | ------------------------------------------ |
| JUnit version   | 6.0.2 (Jupiter)                            |
| Mockito version | 5.21.0                                     |
| AssertJ version | 3.27.6                                     |
| Output redirect | `maven.test.redirectTestOutputToFile=true` |

Integration tests (`its/`) are **disabled by default** (`skipTests=true`). Enable with the `qa` profile.

### PACKAGE Phase

Creates JAR and plugin artifacts.

#### sonar-javascript-plugin (maven-shade-plugin 3.6.1)

Creates **8 shaded JAR variants**:

| Execution ID           | Classifier     | Contents                      |
| ---------------------- | -------------- | ----------------------------- |
| `win-x64`              | win-x64        | Plugin + Windows Node.js      |
| `linux-x64`            | linux-x64      | Plugin + Linux x64 Node.js    |
| `linux-x64-musl`       | linux-x64-musl | Plugin + Alpine Linux Node.js |
| `linux-arm64`          | linux-arm64    | Plugin + Linux ARM64 Node.js  |
| `darwin-x64`           | darwin-x64     | Plugin + macOS x64 Node.js    |
| `darwin-arm64`         | darwin-arm64   | Plugin + macOS ARM64 Node.js  |
| `multi`                | multi          | Plugin + ALL runtimes         |
| `Add manifest entries` | (none)         | Base plugin without runtimes  |

Each shaded JAR:

- Uses `minimizeJar=true` to remove unused dependencies
- Includes `Implementation-Version` and `NodeJs-Min-Version` manifest entries
- Embeds Node.js runtime(s) as `.xz` compressed files

### VERIFY Phase

Validates build outputs.

| Module                      | Execution ID          | Plugin                | Description                         |
| --------------------------- | --------------------- | --------------------- | ----------------------------------- |
| **sonar-javascript-plugin** | `enforce-plugin-size` | maven-enforcer-plugin | Validates JAR file sizes            |
| **coverage-report**         | `report-aggregate`    | jacoco-maven-plugin   | Coverage aggregation (profile only) |

**Expected JAR sizes:**

| Artifact                                 | Min Size | Max Size |
| ---------------------------------------- | -------- | -------- |
| `*-multi.jar`                            | 100 MB   | 130 MB   |
| `*-linux-x64.jar`, `*-win-x64.jar`, etc. | 25 MB    | 55 MB    |
| `*.jar` (base)                           | 8 MB     | 18 MB    |

### INSTALL Phase

Installs all artifacts to the local Maven repository (`~/.m2/repository/org/sonarsource/javascript/`).

---

## NPM Scripts Reference

### Build Scripts

| Script              | Description                                   |
| ------------------- | --------------------------------------------- |
| `bridge:build:fast` | Clear lib, generate meta, compile TypeScript  |
| `bridge:build`      | Build fast + run tests                        |
| `bridge:bundle`     | esbuild bundling for production               |
| `bridge:compile`    | TypeScript compilation with tsgo              |
| `generate-meta`     | Generate `generated-meta.ts` files from RSPEC |
| `validate-quickfix` | Validate quickfix configuration consistency   |

### Rule Management Scripts

| Script                       | Description                                                                                                        |
| ---------------------------- | ------------------------------------------------------------------------------------------------------------------ |
| `deploy-rule-data`           | Copy RSPEC data to `sonar-plugin/javascript-checks/src/main/resources/org/sonar/l10n/javascript/rules/javascript/` |
| `generate-java-rule-classes` | Generate Java check classes                                                                                        |
| `count-rules`                | Update rule counts in documentation                                                                                |
| `new-rule`                   | Scaffold a new rule                                                                                                |

### Internal Scripts (prefixed with `_:`)

| Script                     | Description              |
| -------------------------- | ------------------------ |
| `_:bridge:clear`           | `rimraf lib/*`           |
| `_:bridge:copy-protofiles` | Copy .proto files to lib |

---

## RSPEC Metadata Dependency Chain

Understanding this chain is critical for debugging build issues.

### Data Flow

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ Step 1: rspec-maven-plugin (javascript-checks, generate-resources)              │
│ Downloads from: Remote RSPEC repository (branch: dogfood-automerge)             │
│ Output: resources/rule-data/javascript/*.json, *.html                           │
│         resources/rule-data/css/*.json, *.html                                  │
│ Git status: GITIGNORED                                                          │
└─────────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ Step 2: npm run deploy-rule-data (javascript-checks, generate-resources)        │
│ Input: resources/rule-data/                                                     │
│ Output: sonar-plugin/javascript-checks/src/main/resources/                      │
│         org/sonar/l10n/javascript/rules/javascript/*.json, *.html               │
│         + Sonar_way_profile.json                                                │
│ Git status: COMMITTED (526 files)                                               │
└─────────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ Step 3: npm run generate-meta (bridge, via bridge:build:fast)                   │
│ Input: sonar-plugin/javascript-checks/src/main/resources/                       │
│        org/sonar/l10n/javascript/rules/javascript/                              │
│        (Sonar_way_profile.json + SXXXX.json files)                              │
│ Output: packages/jsts/src/rules/SXXXX/generated-meta.ts                         │
│ Git status: GITIGNORED                                                          │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### Key Directories

| Directory                                                                                       | Git Status    | Purpose                       |
| ----------------------------------------------------------------------------------------------- | ------------- | ----------------------------- |
| `resources/rule-data/`                                                                          | Gitignored    | Fresh RSPEC download location |
| `sonar-plugin/javascript-checks/src/main/resources/org/sonar/l10n/javascript/rules/javascript/` | **Committed** | Rule metadata source of truth |
| `packages/jsts/src/rules/*/generated-meta.ts`                                                   | Gitignored    | Generated ESLint metadata     |

---

## Git Tracking Status

| Path                                                                                                                  | Committed           | Gitignored             |
| --------------------------------------------------------------------------------------------------------------------- | ------------------- | ---------------------- |
| `resources/rule-data/`                                                                                                | No                  | Yes                    |
| `sonar-plugin/javascript-checks/src/main/resources/org/sonar/l10n/javascript/rules/javascript/*.json`                 | **Yes (526 files)** | No                     |
| `sonar-plugin/javascript-checks/src/main/resources/org/sonar/l10n/javascript/rules/javascript/Sonar_way_profile.json` | **Yes**             | No                     |
| `packages/jsts/src/rules/*/generated-meta.ts`                                                                         | No                  | Yes                    |
| `lib/`                                                                                                                | No                  | Yes                    |
| `sonar-plugin/*/src/main/resources/node-info.properties`                                                              | No                  | Yes (cleaned by build) |

---

## Build Profiles

### coverage-report

Enables JaCoCo coverage aggregation.

```bash
mvn clean install -P coverage-report
```

- Adds `coverage-report` module to build
- Generates aggregate report in `coverage/java/jacoco.xml`

### license-regeneration

Downloads and validates third-party licenses.

```bash
mvn clean install -P license-regeneration
```

- Downloads licenses for all dependencies
- Stores in `src/main/resources/licenses/THIRD_PARTY_LICENSES/`
- Validates all license files end with `.txt`

### qa

Enables integration tests (requires `SONARSOURCE_QA=true` environment variable).

```bash
SONARSOURCE_QA=true mvn clean install
```

- Enables `its/plugin/tests`, `its/plugin/fast-tests`, `its/plugin/sonarlint-tests`
- Enables `its/ruling`
- Runs against SonarQube orchestrator

---

## Key Maven Plugins

| Plugin                       | Version  | Purpose                           |
| ---------------------------- | -------- | --------------------------------- |
| maven-shade-plugin           | 3.6.1    | JAR shading with Node.js runtimes |
| exec-maven-plugin            | 3.6.3    | Execute npm, node, git commands   |
| protobuf-maven-plugin        | 0.6.1    | Protobuf → Java code generation   |
| os-maven-plugin              | 1.7.1    | OS detection for protoc           |
| flatten-maven-plugin         | 1.7.3    | POM version resolution            |
| properties-maven-plugin      | 1.3.0    | Property file reading             |
| rspec-maven-plugin           | 1.2.0.91 | RSPEC metadata download           |
| maven-dependency-plugin      | (parent) | Dependency unpacking              |
| maven-enforcer-plugin        | (parent) | Build constraint validation       |
| sonar-packaging-maven-plugin | (parent) | SonarQube plugin packaging        |
| jacoco-maven-plugin          | (parent) | Code coverage                     |

---

## Known Issues and Notes

### Build Order and RSPEC Metadata

**Issue**: The `bridge` module builds **before** `javascript-checks`, but:

- `bridge` runs `generate-meta` which needs `sonar-plugin/javascript-checks/src/main/resources/org/sonar/l10n/javascript/rules/javascript/`
- `sonar-plugin/javascript-checks/src/main/resources/org/sonar/l10n/javascript/rules/javascript/` is populated by `deploy-rule-data` in `javascript-checks`

**Why it works**: The `sonar-plugin/javascript-checks/src/main/resources/org/sonar/l10n/javascript/rules/javascript/` files (526 JSON files) are **committed to git**, so `generate-meta` reads from committed data. On a clean build, fresh RSPEC data is downloaded but `generate-meta` may use stale committed data.

**Potential fix**: Reorder modules in `sonar-plugin/pom.xml`:

```xml
<modules>
  <module>api</module>
  <module>javascript-checks</module>  <!-- Move before bridge -->
  <module>bridge</module>
  <module>css</module>
  <module>sonar-javascript-plugin</module>
  <module>standalone</module>
</modules>
```

This is safe because `javascript-checks` only depends on `api`, not `bridge`.

### Fallback Behavior in generate-meta

The `tools/helpers.ts` `getRspecMeta()` function has a fallback:

```typescript
if (!rspecFileExists) {
  return {
    title: 'Description',
    tags: [],
    type: 'BUG',
    // ... dummy data
  };
}
```

This allows the build to succeed even if RSPEC metadata is missing, but may produce incomplete rule metadata.

### Node.js Version Requirements

The project requires specific Node.js versions, defined in `package.json`:

```json
{
  "engines": {
    "node": "^20.12.0 || ^22.11.0 || ^24.0.0"
  }
}
```

These versions are synced to Java via `tools/sync-nodejs-versions.mjs`.

### Protobuf Compilation

The protobuf files in `packages/jsts/src/parsers/` define the communication protocol between the Java plugin and the Node.js bridge. Both Java and TypeScript code is generated from these definitions.

---

## Quick Reference

### Full Clean Build

```bash
mvn clean install
```

### Skip Tests

```bash
mvn clean install -DskipTests
```

### Build with Coverage

```bash
mvn clean install -P coverage-report
```

### Run Integration Tests

```bash
SONARSOURCE_QA=true mvn clean install
```

### NPM-only Bridge Build

```bash
npm run bridge:build:fast
```

### Regenerate Rule Metadata

```bash
npm run generate-meta
```

### Validate Quickfix Configuration

```bash
npm run validate-quickfix
```
