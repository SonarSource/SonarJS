<h2>Why is this an issue?</h2>
<p>In Express.js, middleware executes in registration order. When <a href="https://www.npmjs.com/package/express-session">express-session</a> is
registered before <code>express.static</code>, session cookies are attached to every response, including static assets like images, CSS, and
JavaScript files.</p>
<p>This creates two exploitation paths:</p>
<p><strong>Cookie exposure</strong>: Proxies, load balancers, or CDNs may cache static asset responses. If the cached response includes a
<code>Set-Cookie</code> header, that session identifier gets served to other users, allowing attackers to hijack sessions without any direct
interaction with the victim.</p>
<p><strong>Cross-site attack vectors</strong>: Attaching sessions to static assets forces the server to process session logic for every image or
script. Depending on the business logic, this mechanism can be used by attackers as exploitation "gadgets".<br> For example, an attacker can use an
<code>&lt;img&gt;</code> or <code>&lt;iframe&gt;</code> on their own malicious site pointing to one of these static assets. After forcing a target
user’s browser to load <code><a href="https://your-site.example.com/icon.png">https://your-site.example.com/icon.png</a></code>, the attacker can
attempt to trigger some specific session-based behaviors, such renewing a session, to probe your server.<br> This is a side-channel attack called a
Cross-Site Leak (XS-Leak).</p>
<h3>What is the potential impact?</h3>
<h4>Session theft</h4>
<p>If an attacker gains access to a user’s session cookie, they can impersonate that user and perform actions on their behalf. This means accessing
private data, making unauthorized transactions, or escalating privileges within the application. For applications handling sensitive information such
as financial data, healthcare records, or personal information, a single compromised session can lead to significant data breaches, regulatory
violations, and reputational damage.</p>
<h2>How to fix it</h2>
<h3>Code examples</h3>
<p>The following code is vulnerable because the session middleware is registered before the static file middleware, causing session cookies to be sent
with every static asset response.</p>
<h4>Noncompliant code example</h4>
<pre data-diff-id="1" data-diff-type="noncompliant">
const express = require('express');
const session = require('express-session');
const path = require('path');

const app = express();

app.use(session({
  secret: process.env.SESSION_SECRET
}));

app.use(express.static(path.join(__dirname, 'app/assets'))); // Noncompliant
</pre>
<h4>Compliant solution</h4>
<pre data-diff-id="1" data-diff-type="compliant">
const express = require('express');
const session = require('express-session');
const path = require('path');

const app = express();

app.use(express.static(path.join(__dirname, 'app/assets')));

app.use(session({
  secret: process.env.SESSION_SECRET
}));
</pre>
<h3>How does this work?</h3>
<p>To fix this weakness, apply the principle of least privilege by ensuring session data is only attached to responses that strictly require it.
Developers must guarantee that session cookies are never exposed to shared caches or Content Delivery Networks (CDNs), which is achieved by correctly
sequencing middleware. By registering <strong>express.static</strong> before the <strong>session middleware</strong>, requests for public assets are
intercepted and served immediately; this prevents the session logic from ever executing for those files, effectively eliminating the session-based
attack surface for static resources.</p>
<h2>Resources</h2>
<h3>Documentation</h3>
<ul>
  <li> Express.js - <a href="https://expressjs.com/en/guide/using-middleware.html">Using middleware</a> </li>
  <li> Express.js - <a href="https://expressjs.com/en/starter/static-files.html">Serving static files in Express</a> </li>
  <li> npm - <a href="https://www.npmjs.com/package/express-session">express-session</a> </li>
</ul>
<h3>Standards</h3>
<ul>
  <li> OWASP - <a href="https://owasp.org/Top10/2021/A05_2021-Security_Misconfiguration/">Top 10 2021 Category A5 - Security Misconfiguration</a>
  </li>
  <li> OWASP - <a href="https://owasp.org/Top10/2025/A02_2025-Security_Misconfiguration/">Top 10 2025 Category A2 - Security Misconfiguration</a>
  </li>
  <li> CWE - <a href="https://cwe.mitre.org/data/definitions/668">CWE-668 - Exposure of Resource to Wrong Sphere</a> </li>
  <li> CWE - <a href="https://cwe.mitre.org/data/definitions/16">CWE-16 - Configuration</a> </li>
</ul>
